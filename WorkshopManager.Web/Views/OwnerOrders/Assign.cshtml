@model WorkshopManager.ViewModels.RepairOrders.AssignMechanicVM
@using WorkshopManager.Web.Helpers

@{
    ViewData["Title"] = "Przydziel zlecenie do mechanika";
}

<h2>Przydziel zlecenie do mechanika</h2>

<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title">Szczegóły zlecenia</h5>
        <dl class="row">
            <dt class="col-sm-3">Klient</dt>
            <dd class="col-sm-9">@Model.ClientFullName</dd>

            <dt class="col-sm-3">Numer rejestracyjny</dt>
            <dd class="col-sm-9">@Model.RegistrationNumber</dd>

            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9">@Html.Raw(StatusHelper.GetStatusBadgeHtml(Model.Status))</dd>

            <dt class="col-sm-3">Opis usterki</dt>
            <dd class="col-sm-9">@Model.IssueDescription</dd>
        </dl>
    </div>
</div>

<form asp-action="Assign" method="post">
    <input type="hidden" asp-for="OrderId" />

    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="mb-3">
        <label asp-for="SelectedMechanicId" class="form-label"></label>
        <select asp-for="SelectedMechanicId" class="form-select">
            <option value="">-- wybierz mechanika --</option>
            @foreach (var mechanic in Model.Mechanics)
            {
                <option value="@mechanic.Id"
                        selected="@(Model.SelectedMechanicId == mechanic.Id)">
                    @mechanic.FullName
                </option>
            }
        </select>
        <span asp-validation-for="SelectedMechanicId" class="text-danger"></span>
    </div>

    <hr class="my-4" />

    <h5 class="mb-3">Wycena naprawy</h5>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label asp-for="EstimatedCost" class="form-label"></label>
            <div class="input-group">
                <input asp-for="EstimatedCost" type="number" step="0.01" min="0.01" class="form-control" id="estimatedCost" />
                <span class="input-group-text">PLN</span>
            </div>
            <span asp-validation-for="EstimatedCost" class="text-danger"></span>
        </div>

        <div class="col-md-6 mb-3">
            <label asp-for="VatRate" class="form-label"></label>
            <select asp-for="VatRate" class="form-select" id="vatRate">
                @if (Model.VatRate == 8)
                {
                    <option value="8" selected>8%</option>
                    <option value="23">23%</option>
                }
                else
                {
                    <option value="8">8%</option>
                    <option value="23" selected>23%</option>
                }
            </select>
            <span asp-validation-for="VatRate" class="text-danger"></span>
        </div>
    </div>

    <div class="card bg-light mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Kwota netto:</strong>
                    <div id="nettoAmount">-</div>
                </div>
                <div class="col-md-4">
                    <strong>Kwota VAT:</strong>
                    <div id="vatAmount">-</div>
                </div>
                <div class="col-md-4">
                    <strong>Kwota brutto:</strong>
                    <div id="bruttoAmount" class="fs-5 text-primary">-</div>
                </div>
            </div>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">
        Zapisz
    </button>
    <a asp-action="Index" class="btn btn-secondary">
        Powrót do listy
    </a>
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        function calculateVAT() {
            const estimatedCost = parseFloat(document.getElementById('estimatedCost').value);
            const vatRate = parseInt(document.getElementById('vatRate').value);

            if (isNaN(estimatedCost) || estimatedCost <= 0 || isNaN(vatRate) || vatRate ===  0) {
                document.getElementById('nettoAmount').textContent = '-';
                document.getElementById('vatAmount').textContent = '-';
                document.getElementById('bruttoAmount').textContent = '-';
                return;
            }

            const netto = estimatedCost;
            const vat = (netto * vatRate) / 100;
            const brutto = netto + vat;

            document.getElementById('nettoAmount').textContent = netto.toFixed(2) + ' PLN';
            document.getElementById('vatAmount').textContent = vat.toFixed(2) + ' PLN';
            document.getElementById('bruttoAmount').textContent = brutto.toFixed(2) + ' PLN';
        }

        document.getElementById('estimatedCost').addEventListener('input', calculateVAT);
        document.getElementById('vatRate').addEventListener('change', calculateVAT);

        // Przelicz przy ładowaniu strony jeśli są wartości
        window.addEventListener('load', calculateVAT);
    </script>
}
