@model WorkshopManager.Model.DataModels.RepairOrder
@using WorkshopManager.Web.Helpers

@{
    ViewData["Title"] = "Szczegóły zlecenia";
}

<h2>Szczegóły zlecenia #@Model.Id</h2>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user"></i> Dane klienta</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Imię i nazwisko</dt>
                    <dd class="col-sm-8">@Model.Client.FirstName @Model.Client.LastName</dd>

                    <dt class="col-sm-4">Email</dt>
                    <dd class="col-sm-8">@Model.Client.Email</dd>

                    <dt class="col-sm-4">Telefon</dt>
                    <dd class="col-sm-8">@(Model.Client.PhoneNumber ?? "brak")</dd>
                </dl>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-car"></i> Dane pojazdu</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Numer rejestracyjny</dt>
                    <dd class="col-sm-8"><strong>@Model.RegistrationNumber</strong></dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Status i mechanik</h5>
    </div>
    <div class="card-body">
        <dl class="row">
            <dt class="col-sm-3">Status zlecenia</dt>
            <dd class="col-sm-9">@Html.Raw(StatusHelper.GetStatusBadgeHtml(Model.Status))</dd>

            <dt class="col-sm-3">Przydzielony mechanik</dt>
            <dd class="col-sm-9">
                @if (Model.Mechanic != null)
                {
                    <span>@Model.Mechanic.FirstName @Model.Mechanic.LastName</span>
                }
                else
                {
                    <span class="text-muted">Nie przydzielono</span>
                }
            </dd>

            <dt class="col-sm-3">Data zgłoszenia</dt>
            <dd class="col-sm-9">@Model.SubmissionDate.ToString("dd.MM.yyyy HH:mm")</dd>

            @if (Model.StartDate.HasValue)
            {
                <dt class="col-sm-3">Data rozpoczęcia</dt>
                <dd class="col-sm-9">@Model.StartDate.Value.ToString("dd.MM.yyyy HH:mm")</dd>
            }

            @if (Model.EndDate.HasValue)
            {
                <dt class="col-sm-3">Data zakończenia</dt>
                <dd class="col-sm-9">@Model.EndDate.Value.ToString("dd.MM.yyyy HH:mm")</dd>
            }
        </dl>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-warning">
        <h5 class="mb-0"><i class="fas fa-tools"></i> Opis usterki</h5>
    </div>
    <div class="card-body">
        <p>@Model.EntryIssueDescription</p>
    </div>
</div>

@if (Model.EntryEstimatedCost.HasValue && Model.VatRate.HasValue)
{
    var netto = Model.EntryEstimatedCost.Value;
    var vat = (netto * Model.VatRate.Value) / 100;
    var brutto = netto + vat;

    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Pierwotna wycena</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Kwota netto:</strong>
                    <div class="fs-5">@netto.ToString("N2") PLN</div>
                </div>
                <div class="col-md-4">
                    <strong>VAT (@Model.VatRate%):</strong>
                    <div class="fs-5">@vat.ToString("N2") PLN</div>
                </div>
                <div class="col-md-4">
                    <strong>Kwota brutto:</strong>
                    <div class="fs-4 fw-bold text-primary">@brutto.ToString("N2") PLN</div>
                </div>
            </div>
        </div>
    </div>
}

@if (Model.AdditionalCosts != null && Model.AdditionalCosts.Any())
{
    <div class="card mb-3 border-warning">
        <div class="card-header bg-warning bg-opacity-25">
            <h5 class="mb-0">
                <i class="fas fa-plus-circle"></i> Koszty dodatkowe
            </h5>
        </div>
        <div class="card-body">
            @foreach (var cost in Model.AdditionalCosts)
            {
                <div class="alert alert-secondary mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="mb-1"><strong>@cost.Description</strong></p>
                            <p class="mb-1"><strong>Kwota (netto):</strong> @cost.Cost.ToString("N2") PLN</p>
                            <small class="text-muted">Dodano: @cost.AddedDate.ToString("dd.MM.yyyy HH:mm")</small>
                        </div>
                        @if (cost.IsAccepted)
                        {
                            <span class="badge bg-success">
                                <i class="fas fa-check"></i> Zaakceptowano
                                <br />
                                <small>@cost.AcceptedDate?.ToString("dd.MM.yyyy HH:mm")</small>
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-clock"></i> Oczekuje na akceptację
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@if (Model.EntryEstimatedCost.HasValue && Model.VatRate.HasValue)
{
    var totalAdditionalCosts = Model.AdditionalCosts?.Sum(ac => ac.Cost) ?? 0;
    var totalNetto = Model.EntryEstimatedCost.Value + totalAdditionalCosts;
    var totalVat = (totalNetto * Model.VatRate.Value) / 100;
    var totalBrutto = totalNetto + totalVat;

    <div class="card mb-3 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="fas fa-calculator"></i> SUMA DO ZAPŁATY</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Suma netto:</strong>
                    <div class="fs-5">@totalNetto.ToString("N2") PLN</div>
                    @if (totalAdditionalCosts > 0)
                    {
                        <small class="text-muted">
                            (Podstawa: @Model.EntryEstimatedCost.Value.ToString("N2") + Dodatkowe: @totalAdditionalCosts.ToString("N2"))
                        </small>
                    }
                </div>
                <div class="col-md-4">
                    <strong>VAT (@Model.VatRate%):</strong>
                    <div class="fs-5">@totalVat.ToString("N2") PLN</div>
                </div>
                <div class="col-md-4">
                    <strong>Suma brutto:</strong>
                    <div class="fs-3 fw-bold text-danger">@totalBrutto.ToString("N2") PLN</div>
                </div>
            </div>
        </div>
    </div>
}

@if (Model.Tasks != null && Model.Tasks.Any())
{
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-tasks"></i> Wykonane prace</h5>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Opis pracy</th>
                        <th>Koszt</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var task in Model.Tasks)
                    {
                        <tr>
                            <td>@task.Description</td>
                            <td>@task.Cost.ToString("N2") PLN</td>
                            <td>
                                @if (task.IsCompleted)
                                {
                                    <span class="badge bg-success">Ukończono</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">W trakcie</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<div class="mb-3">
    <a asp-action="Index" class="btn btn-secondary btn-lg">
        <i class="fas fa-arrow-left"></i> Powrót do listy
    </a>
    <a asp-action="ChangeStatus" asp-route-id="@Model.Id" class="btn btn-warning btn-lg">
        <i class="fas fa-sync-alt"></i> Zmień status
    </a>
    <a asp-action="Assign" asp-route-id="@Model.Id" class="btn btn-primary btn-lg">
        <i class="fas fa-edit"></i> Edytuj wycenę
    </a>
    @if (Model.EntryEstimatedCost.HasValue && Model.VatRate.HasValue)
    {
        <a asp-action="AddAdditionalCost" asp-route-id="@Model.Id" class="btn btn-info btn-lg">
            <i class="fas fa-plus-circle"></i> Dodaj koszty
        </a>
    }
</div>
